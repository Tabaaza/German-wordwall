<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>German ↔ English Reels — Flashcards</title>

<style>
  :root{
    --bg1: #071028;
    --bg2: #081226;
    --card-bg: rgba(255,255,255,0.02);
    --accent: #8bd3c7;
    --muted: #a6b0c3;
    --glass: rgba(255,255,255,0.03);
    --card-radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0;
    font-family:Inter,system-ui; 
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#eaf2ff;
  }

  body { overflow: hidden !important; } /* YOUR UPDATE */

  .app {
    height:100vh; display:flex;
    align-items:center; justify-content:center;
    padding:20px;
  }

  .viewer {
    width:min(720px,96vw);
    height:min(820px,92vh);
    border-radius:var(--card-radius);
    overflow:hidden;
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    box-shadow:0 18px 60px rgba(3,8,20,0.6);
    display:flex; align-items:center; justify-content:center;
    position:relative;
  }

  #cardsRoot { position:absolute; inset:0; }

  .card {
    position:absolute; inset:0;
    padding:30px;
    display:flex; flex-direction:column;
    text-align:center;
    transition:transform 420ms, opacity 300ms;
  }

  /* ★ YOUR CHANGE — more padding above theme */
  .theme {
    text-align:center;
    width:100%;
    padding-top:50px; /* updated */
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,255,255,0.02);
  }
  .theme .title{
    display:inline-block;
    padding:8px 14px;
    border-radius:999px;
    background:var(--glass);
    color:var(--muted);
    font-size:14px;
  }

  .content{
    flex:1; display:flex;
    flex-direction:column;
    justify-content:center; /* top-center layout */
    align-items:center;
    padding:20px 8%;
  }

  .german{
    font-size: clamp(28px, 6.8vw, 56px);
    font-weight:700;
    margin:0;
  }
  .english{
    font-size:clamp(14px,3vw,20px);
    margin-top:16px;
    color:var(--accent);
  }

  /* ★ example sentences reveal on flip */
  .example-box{
    margin-top:20px;
    display:none;
    font-size:15px;
    color:var(--muted);
    line-height:1.4;
  }

  .bookmark-btn{ margin-left:10px; padding:6px 8px; font-size:16px }
  .bookmark-active{ color: #ffd166; }

  .topbar{position:absolute;left:18px;top:18px; display:flex;gap:10px;}
  .chip{background:var(--glass);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted);}

  .hint{position:absolute;right:18px;top:18px;font-size:13px;color: #ffffff;
background: rgba(108, 42, 247, 1);;padding:8px 12px;border-radius:10px;}

  .bottombar{
    position:absolute;bottom:14px;left:14px;right:14px;
    display:flex;align-items:center;gap:12px;
  }
  .progress{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;}
  .progress i{height:100%;display:block;background:linear-gradient(90deg,#8bd3c7,#8ac8f0);width:0;}

  .btn{border:1px solid rgba(255,255,255,0.06);background:transparent;padding:8px 10px;color:var(--muted);border-radius:10px;cursor:pointer;}
  .btn-star{border:1px solid rgba(255,255,255,0.06);background:transparent;padding:8px 10px;color:#ffd166;border-radius:10px;cursor:pointer;}
</style>
</head>

<body>
<div class="app">
  <div class="viewer" id="viewer">

    <div class="topbar">
      <div class="chip" id="countChip">0/0</div>
      <div class="chip">Swipe ↑ / ↓</div>
    </div>
    <div class="hint">Tap to reveal example</div>

    <div id="cardsRoot"></div>

    <div class="bottombar">
      <div class="progress"><i id="progressFill"></i></div>
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
      <button class="btn" id="shuffleBtn">Shuffle</button>
      <button class="btn" id="toggleBookmarksBtn">Bookmarks</button>
    </div>

  </div>
</div>

<script>
const FILE_URL = "/mnt/data/file-3.txt";  // uploaded file

let themes = [];
let cards = [];
let index = 0;
const STORAGE_KEY = `german-wordwall:${FILE_URL}`;
const BOOKMARKS_KEY = `german-wordwall:bookmarks:${FILE_URL}`;

let bookmarks = {};
let showBookmarks = false;

function loadBookmarks(){
  try{
    const raw = localStorage.getItem(BOOKMARKS_KEY);
    bookmarks = raw ? JSON.parse(raw) : {};
  }catch(e){ bookmarks = {}; }
}

function saveBookmarks(){
  try{ localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks)); }catch(e){}
}

function cardId(c){
  // stable id per card: theme|german|english
  return `${(c.theme||'')}|${c.g}|${c.e}`;
}

function saveIndex() {
  try { localStorage.setItem(STORAGE_KEY, String(index)); } catch (e) {}
}

function restoreIndex(total) {
  try {
    const v = localStorage.getItem(STORAGE_KEY);
    if (!v) return 0;
    const n = parseInt(v, 10);
    if (Number.isInteger(n) && n >= 0 && n < total) return n;
  } catch (e) {}
  return 0;
}

/* -----------------------------
   NEW PARSER FOR UPDATED FORMAT
   ----------------------------- */

function rtfToText(raw){
  return raw
    .replace(/\\par[d]?/g,"\n")
    .replace(/\\'[0-9a-fA-F]{2}/g,"")
    .replace(/\\[a-zA-Z]+\d* ?/g,"")
    .replace(/[{}]/g,"")
    .replace(/\r/g,"\n");
}

function parseNewFormat(text) {
  // Normalize newlines and split into non-empty lines
  const rawLines = text.replace(/\r/g, "\n").split("\n");
  const lines = rawLines.map(l => l.trim()).filter(l => l.length > 0);

  const themes = [];
  let currentTheme = null;
  let lastItem = null;

  for (let line of lines) {
    // Remove a leading '*' and any whitespace that often prefixes lines
    let l = line.replace(/^\*\s?/, "").trim();

    // SATZ line (German example). Accept variations like "Satz:..." or "Satz: ..." or "Satz:Text"
    const satzMatch = l.match(/^Satz\s*[:：]?\s*(.+)$/i);
    if (satzMatch && lastItem) {
      lastItem.satz = satzMatch[1].trim();
      continue;
    }

    // TRANSLATION line for example sentence
    const translMatch = l.match(/^Translation\s*[:：]?\s*(.+)$/i);
    if (translMatch && lastItem) {
      lastItem.satz_en = translMatch[1].trim();
      continue;
    }

    // VOCAB item: support optional leading index like "91. erfolgreich - successful"
    const vocabMatch = l.match(/^(?:\d+\.\s*)?(.+?)\s*-\s*(.+)$/);
    if (vocabMatch) {
      // Ensure we have a theme to attach to
      if (!currentTheme) {
        currentTheme = { title: "Misc", items: [] };
        themes.push(currentTheme);
      }

      lastItem = {
        g: vocabMatch[1].trim(),
        e: vocabMatch[2].trim(),
        satz: "",
        satz_en: ""
      };
      currentTheme.items.push(lastItem);
      continue;
    }

    // THEME HEADER: lines like "1. Menschen & Beziehungen (People & Relationships)"
    const themeMatch = l.match(/^(\d+)\.\s*(.+)$/);
    if (themeMatch) {
      currentTheme = { title: themeMatch[2].trim(), items: [] };
      themes.push(currentTheme);
      lastItem = null;
      continue;
    }

    // If we reach here, the line didn't match known patterns. Try a relaxed guess:
    // some files may contain lines like "Satz:Räum bitte..." (no space after the *),
    // but removing the leading '*' above already handles many cases. Otherwise ignore.
  }

  return themes;
}

/* -----------------------------
   FLATTEN FOR CARD VIEW
----------------------------- */
function flatten(themes){
  let out = [];
  themes.forEach(t=>{
    t.items.forEach(word=>{
      out.push({
        theme: t.title,
        ...word
      });
    });
  });
  return out;
}

/* -----------------------------
   RENDERING
----------------------------- */
function renderCards(){
  const root = document.getElementById("cardsRoot");
  root.innerHTML = "";

  const list = showBookmarks ? cards.filter(c=>bookmarks[cardId(c)]) : cards;

  list.forEach((c,i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.index = i;
    // store original index for reference (not strictly required)
    card.dataset.origId = cardId(c);

    card.style.transform = `translateY(${(i-index)*110}%)`;

    const starred = !!bookmarks[cardId(c)];

    card.innerHTML = `
      <div class="theme">
        <div class="title">${c.theme}</div>
        <button class="btn-star bookmark-btn ${starred? 'bookmark-active':''}" data-id="${cardId(c)}" aria-pressed="${starred}">${starred? '★':'☆'}</button>
      </div>

      <div class="content">
        <h1 class="german">${c.g}</h1>

        <div class="example-box">
          <div class="english">${c.e}</div>
          <strong>Satz:</strong> ${c.satz}<br><br>
          <strong>EN:</strong> ${c.satz_en}
        </div>
      </div>
    `;

    /* Flip to show example */
    card.addEventListener("click",()=>{
      const box = card.querySelector(".example-box");
      box.style.display = box.style.display==="block" ? "none" : "block";
    });

    /* Bookmark toggle */
    const btn = card.querySelector('.bookmark-btn');
    if(btn){
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const id = btn.dataset.id;
        if(bookmarks[id]){ delete bookmarks[id]; btn.classList.remove('bookmark-active'); btn.textContent='☆'; btn.setAttribute('aria-pressed','false'); }
        else { bookmarks[id]=true; btn.classList.add('bookmark-active'); btn.textContent='★'; btn.setAttribute('aria-pressed','true'); }
        saveBookmarks();
      });
    }

    root.appendChild(card);
  });

  updateUI();
}

function updateUI(){
  const list = showBookmarks ? cards.filter(c=>bookmarks[cardId(c)]) : cards;
  const total = list.length;
  document.getElementById("countChip").textContent = `${Math.min(index+1,total)}/${total}`;
  document.getElementById("progressFill").style.width = (total?((index+1)/total*100):0)+"%";

  document.querySelectorAll(".card").forEach(card=>{
    const i = +card.dataset.index;
    const offset = i-index;
    card.style.transform = `translateY(${offset*110}%)`;
    card.style.opacity = Math.abs(offset)>2 ? "0" : "1";
  });
}

/* -----------------------------
   NAVIGATION
----------------------------- */
function setIndex(i){
  if (!cards.length) { index = 0; return; }
  // wrap and clamp
  index = ((i % cards.length) + cards.length) % cards.length;
  updateUI();
  saveIndex();
}

function next(){ setIndex(index+1); }
function prev(){ setIndex(index-1); }

document.getElementById("nextBtn").onclick = next;
document.getElementById("prevBtn").onclick = prev;

document.getElementById("shuffleBtn").onclick = ()=>{
  cards.sort(()=>Math.random()-0.5);
  // after shuffling, reset to start and persist
  index = 0;
  saveIndex();
  renderCards();
};

document.getElementById('toggleBookmarksBtn').onclick = ()=>{
  showBookmarks = !showBookmarks;
  const btn = document.getElementById('toggleBookmarksBtn');
  btn.textContent = showBookmarks ? 'All' : 'Bookmarks';
  // reset index when toggling view
  index = 0;
  saveIndex();
  renderCards();
};

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowDown") next();
  if(e.key==="ArrowUp") prev();
});

/* -----------------------------
   TOUCH + WHEEL
----------------------------- */
let startY=null;
document.addEventListener("touchstart",e=>{
  startY=e.touches[0].clientY;
});
document.addEventListener("touchend",e=>{
  let endY=e.changedTouches[0].clientY;
  if(endY < startY-50) next();
  if(endY > startY+50) prev();
});

document.addEventListener("wheel",e=>{
  if(e.deltaY>10) next();
  if(e.deltaY<-10) prev();
});

/* -----------------------------
   LOAD FILE
----------------------------- */
async function loadFile(){
  try{
    const res = await fetch(FILE_URL);
    const raw = await res.text();
    console.log('DEBUG: fetched raw length', raw.length);
    console.log('DEBUG: raw preview:\n', raw.slice(0,800));
    const plain = rtfToText(raw);
    themes = parseNewFormat(plain);
    cards = flatten(themes);
    // load bookmarks and restore last index for this file if available
    loadBookmarks();
    index = restoreIndex(cards.length || 1);
    console.log('DEBUG: parsed themes', themes.length, 'cards', cards.length);
    console.log('DEBUG: sample cards', cards.slice(0,6));
  }catch(e){
    alert("Error loading file.");
    cards = [];
  }

  if(!cards.length){
    cards=[{theme:"Sample",g:"Hallo",e:"Hello"}];
  }

  renderCards();
  // ensure UI and stored index are synced
  saveIndex();
}

loadFile();
</script>

</body>
</html>
